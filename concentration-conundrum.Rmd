---
title: "concentration-conundrum-r"
author: "Jake Martin"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_download: true
    code_folding: hide
    depth: 4
    number_sections: no
    theme:  cosmo
    toc: yes
    toc_float: yes
    toc_depth: 4
  pdf_document:
    toc: yes
knit: |
  (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = paste0(
       'index.html'
      ),
      envir = globalenv()
    )
  })
---

#########################
# README
#########################


**ARTICLE** <br>
This R script is associated with **Martin et al (2025)** "Concentration Conundrum in Behavioural Ecotoxicology: the minimum doses tested in behavioural ecotoxicology are on average over three hundred times higher then surface waters" DOI:
<br>

**AUTHORS**<br>
Jake M. Martin <sup>1,2,3</sup>* <br>
Jack A. Band <sup>2,4</sup> <br>
Erin S. McCallum <sup>1</sup> 
<br>

**AFFILIATIONS**<br>
(1) School of Life and Environmental Sciences, Deakin University, Geelong, Australia <br>
(2) Department of Wildlife, Fish, and Environmental Studies, Swedish University of Agricultural Sciences, Umeå, Sweden <br>
(3) School of Biological Sciences, Monash University, Melbourne, Australia <br>
(4) Institute of Zoology, Zoological Society of London, London, United Kingdom <br>
(*) Corresponding author 
<br>

**AIM** <br>
The aim of this study is two-fold: (1) to compare the target pharmaceuticals tested in behavioural ecotoxicology to what have been detected in the environment, highlighting potential targets for future investigation; (2) identify whether tested concentrations in behavioural ecotoxicology studies reflect those that are detected in surface waters and/or waste water.
<br>


**METHODS** <br>
To achieve these aims, this study capitalises on four extensive open access databases, one of which focuses on peer-review research on the behavioural ecotoxicology of pharmaceuticals<sup>1</sup>, with the remaining three focusing on pharmaceutical environmental occurrence and concentrations<sup>2,3,4</sup>.<br>

(1) The Evidence of the Impacts of Pharmaceuticals on Aquatic Animal Behaviour (EIPAAB) database (Martin et al. 2024; DOI: https://doi.org/10.32942/X2NG9R) <br>

(2) The Umwelt Bundesamt Pharmaceuticals in the environment (PHARMS-UBA) database (access link: https://www.umweltbundesamt.de/en/database-pharmaceuticals-in-the-environment-1) <br>

(3) the Wilkinson global river survey data (Wilkinson et al 2022: DOI: https://doi.org/10.1073/pnas.2113947119), specifically "Dataset S4. Database of pharmaceutical concentrations at all the sampling locations monitored in this project" <br>

(4) The NORMAN database 
<br>

The four databases were filtered to focus on pharmaceuticals compounds, environmental samples from surface waters/waste water (e.g. rivers, streams, lakes, sea/oceans, ponds, waste water treatment plant [WWTP] effluent), and environmental/lab samples measured in units of mass per volume of water, where necessary. <br>

**RESULTS**<br>
Through the combination of these open access databases, we were able to compare the compounds and concentrations used in over **X** behavioural ecotoxicology exposures, to the environmental detection and concentrations of over **X** pharmaceuticals. In doing this, we detected a positive association with the number of behavioural ecotoxicology tests per compound and the total number of environmental detections, as well as the proportion of positive detections (i.e. relative number of samples above limit of detection). With that said, there was a number of compounds with high environmental detection, with no associated behavioural toxicological data, or very few examples. In terms of concentrations, on average, concentrations used in behavioural ecotoxicology were **309 times higher** then median surface water concentrations, and 12 times higher then those in effluent. <br>

**SCRIPT** <br>
This is an R markdown script written in R studio (2023.09.0+463 “Desert Sunflower” Release). The 'concentration-conundrum' git repository hosts this script, and if downloaded (or pulled) it will reproduce all data tidy/filter, analysis, and visualisations used in Martin et al (2025). The GitHub repository includes all raw input data from the four open access databases, as well as all output data and figures. I have tried to structure this code with Open, Reliable, and Transparent (ORT) coding practices in mind. Feel free to reach out if anything is unclear.

The R script first cleans and filters each databases to make them comparable. In terms of filtering, we target pharmaceutical compounds, surface waters/waste water effluent, and environmental/lab samples measured in units of mass per volume of water (e.g. ug/L). <br>

GitHub: https://github.com/JakeMartinResearch/concentration-conundrum

#########################
# Contact
#########################

**Jake M. Martin** <br>

**Email**: jake.martin@deakin.edu.au (or jake.martin.research@gmail.com) <br>

**Web**: jake.martin.org <br>

**GitHub**: https://github.com/JakeMartinResearch <br>

#########################
# Knit settings 
#########################

Here we define our Knit settings, to make the output more user friendly, and to cache output for faster knitting.

```{r setup}
#kniter seetting
knitr::opts_chunk$set(
message = FALSE,
warning = FALSE, # no warnings
cache = TRUE,# Cacheing to save time when kniting
tidy = TRUE
)
```

#########################
# Required packages
#########################

These are the R packages required for this script. You will need to install a package called pacman to run the p_load function. 

```{r, message=FALSE, results='hide'}
# this installs and load packages
# need to install pacman
pacman::p_load("ggplot2", 
               "ggthemes", 
               "ggfortify",
               "ggridges",
               "gghalves",
               "ggExtra",
               "plotly",
               "colorspace", 
               "ggrepel", 
               "ggdist",
               "gt", # data visualisation
               
               "tidyverse", 
               "janitor", 
               "readxl", 
               "broom" # data tidy
                       )
```


#########################
# Custom functions 
#########################

Here are some custom function used within this script. <br>

*tidy_string* : To tidy the names in UBA database

```{r}
tidy_string <- function(string) {
  string %>%
    stringr::str_remove_all("[-()]") %>%  # Remove unwanted characters
    stringr::str_replace_all("\\s{2,}", " ") %>%  # Replace double spaces with a single space
    stringr::str_replace_all("\\s", "_") %>%  # Replace spaces with underscores
    stringr::str_replace_all("[/]", "_") %>% 
    stringr::str_replace_all("[µ]", "u") %>% 
    tolower()
}
```

*make_na* : Takes a sting and replaces with NA based on specification in the UBA database (e.g. -9999, [-], -, or "")

```{r}
make_na <- function(string) {
    dplyr::case_when(
      string == -9999 ~ NA,
      string == "[-]" ~ NA,
      string == "-" ~ NA,
      string == "" ~ NA,
      TRUE ~ string
      )
}
```

*sentence_case* : Makes a string into sentence case

```{r}
sentence_case <- function(text) {
  text <- tolower(text) # Convert the entire text to lowercase
  text <- sub("^(\\s*\\w)", "\\U\\1", text, perl = TRUE) # Capitalise the first letter
  return(text)
}
```


#########################
# Directories 
#########################

Here we define the directories for the project. We also make the output directories if they don't already exist. <br>

## Input

These are the input directors for the databases used in this project. <br>

**input_wd**: Directory for the input data

```{r}
wd <- getwd() # getwd tells us what the current wd is, we are using this to drop it in a variable called wd
input_wd <- paste0(wd, "./input-data") # creates a variable with the name of the wd we want to use
```


## Output

These are output directories for data and figures.<br>

**output_wd**: Directory for the output data

```{r, echo = TRUE, results = "hide"}
wd <- getwd() # getwd tells us what the current wd is, we are using this to drop it in a variable called wd
output_wd <- paste0(wd, "./output-data") # creates a variable with the name of the wd we want to use
ifelse(!dir.exists("output-data"), dir.create("output-data"), "Folder already exists")
```

**output_fig_wd**: Directory for the output figures

```{r, echo = TRUE, results = "hide"}
output_fig_wd <- paste0(wd, "./output-fig")
ifelse(!dir.exists("output-fig"), dir.create("output-fig"), "Folder already exists")
```


#########################
# Databases 
#########################

In this section of the script we will import the different databases and tidy them. <br>

## EIPAAB

Import the EIPAAB database, there are 901 articles and 1739 rows of data.

```{r}
setwd(input_wd)
EIPAAB <- read.csv("EIPAAB-database.csv")

articles <- EIPAAB %>% 
  dplyr::distinct(article_id) %>% 
  nrow(.)

data_points <- EIPAAB %>% 
  nrow(.)

print(paste0("n articles = ", articles, "; n data rows = ", data_points))
```

### Filtering

We are **filter** the EIPAAB database for studies with an Environmental motivation and studies with concentrations reported in mass per volume of water (ug/L). We now have 463 articles and 767 rows of data (we removed 438 articles and 972 rows of data).

```{r}
EIPAAB <- EIPAAB %>% 
  dplyr::mutate(compound_min_dose_unit_std = tidy_string(compound_min_dose_unit_std),
                compound_max_dose_unit_std = tidy_string(compound_max_dose_unit_std)) %>% 
  dplyr::filter(study_motivation == "Environmental", 
                compound_min_dose_unit_std == "ug_l", compound_max_dose_unit_std == "ug_l") %>% 
  dplyr::mutate(compound_name = tolower(compound_name),  
                compound_pubchem_name = tolower(compound_pubchem_name))

articles <- EIPAAB %>% 
  dplyr::distinct(article_id) %>% 
  nrow(.)

data_points <- EIPAAB %>% 
  nrow(.)

print(paste0("Filtered: n articles = ", articles, "; n data rows = ", data_points))
```
<br>
There are 184 compounds in this filtered dataset.

```{r}
eipaab_cas_list <- EIPAAB %>% 
  dplyr::distinct(compound_cas) %>% 
  pull(compound_cas)

eipaab_name_list <- EIPAAB %>% 
  dplyr::distinct(compound_name) %>% 
  pull(compound_name)

eipaab_pubchem_name_list <- EIPAAB %>% 
  dplyr::distinct(compound_pubchem_name) %>% 
  pull(compound_pubchem_name)

eipaab_cas_n <- length(eipaab_cas_list)
eipaab_name_n <- length(eipaab_name_list)
eipaab_pubchem_name_n <- length(eipaab_pubchem_name_list)

print(paste0("n CAS numbers = ", eipaab_cas_n, "; n compound names = ", eipaab_name_n, "; n PubChem compound names = ", eipaab_pubchem_name_n))
```

*Note: One of the compounds must have two pubchem names, this isn't an issue, we will use all identifiers to search the environmental occurrence databases*

### EIPAAB long

Here we will make a new EIPAAB data frame, **EIPAAB_con_long**, that we will be able to work with more easily. We have added a few new columns so that we can combined it with the environmental occurrence data matrix_group, n_units and source.

```{r}
EIPAAB_con_long <- EIPAAB %>% 
  dplyr::select(unique_row_id, compound_cas, compound_name, compound_pubchem_name, compound_min_dose_std, compound_max_dose_std) %>% 
    pivot_longer(
    cols = c(compound_min_dose_std, compound_max_dose_std),
    names_to = "concentration_type",
    values_to = "value"
  ) %>%
  mutate(concentration_type = case_when(
    concentration_type == "compound_min_dose_std" ~ "min",
    concentration_type == "compound_max_dose_std" ~ "max",
    TRUE ~ NA
  ),
  matrix_group = "test",
  n_units = 1,
  source = "eipaab")
```


## UBA

Import the UBA database, tidy the column names and data. This is the whole UBA database.

```{r}
setwd(input_wd)

column_fix_na <- c("sampling_period_start", "sampling_period_end", "number_of_samples_analysed", "unit_original", "unit_standard", "unit_lo_d", "unit_lo_d_standardized", "lo_d_standardized", "lo_d_limit_of_detection", "sampling_province")

column_fix_chr <- c("matrix", "unit_original", "unit_standard", "unit_lo_d", "unit_lo_d_standardized", "statistics")

UBA <- read_excel("pharms-uba_v3_2021_0.xlsx", skip = 2) %>% 
  janitor::clean_names() %>%
  dplyr::mutate(name_of_analyte = tolower(name_of_analyte),
                across(all_of(column_fix_na), make_na),
                across(all_of(column_fix_chr), tidy_string),
                cas_number = str_replace_all(cas_number, "–", "-"))
```


### Filtering

We are **filtering** for only measures in unit standard of ug/L. We are only comparing water-borne concentrations (i.e. in mass per volume of water). We are also only selecting some matrix of interest, and re-allocating the different matrix into broader categories. The matrix of interest that we have selected for this investigation are: <br> 

***Surfacewaters***: "surface_water_river_stream", "surface_water_unspecific", "surface_water_lake", "surface_water_sea_or_ocean", "surface_water_aquaculture", "surface_water_pond" <br>

***WWTP effluent***: "wwtp_effluent_treated", "wwtp_secondary_effluent", "wwtp_primary_effluent", "wwtp_desinfection_effluent" <br>

***WWTP inflow***: "wwtp_inflow_untreated" <br>

***Treated sewage***: "sewage_hospital_treated", "sewage_urban_treated", "sewage_livestock_treated" <br>

***Untreated sewage***: "sewage_hospital_untreated", "sewage_industrial_untreated", "sewage_urban_untreated", "sewage_livestock_untreated", "sewage_untreated_unspecific"

```{r}
matrix_surfacewater <- c("surface_water_river_stream", "surface_water_unspecific", "surface_water_lake", "surface_water_sea_or_ocean", "surface_water_aquaculture", "surface_water_pond")

matrix_wwtp_effluent <- c("wwtp_effluent_treated", "wwtp_secondary_effluent", "wwtp_primary_effluent", "wwtp_desinfection_effluent")

matrix_wwtp_inflow <- c("wwtp_inflow_untreated")

matrix_sewage_treated <- c("sewage_hospital_treated", "sewage_urban_treated", "sewage_livestock_treated")

matrix_sewage_untreated <- c("sewage_hospital_untreated", "sewage_industrial_untreated", "sewage_urban_untreated", "sewage_livestock_untreated", "sewage_untreated_unspecific")

matrix_of_intrest <- c(matrix_surfacewater, matrix_wwtp_effluent, matrix_wwtp_inflow, matrix_sewage_treated, matrix_sewage_untreated)


UBA <-  UBA %>% 
  dplyr::filter(unit_standard == "ug_l") %>% 
  dplyr::filter(matrix %in% matrix_of_intrest) %>% 
  dplyr::mutate(matrix_group = case_when(
    matrix %in% matrix_surfacewater ~ "surfacewater",
    matrix %in% matrix_wwtp_effluent ~ "effluent",
    matrix %in% matrix_wwtp_inflow ~ "inflow",
    matrix %in% matrix_sewage_treated ~ "treated sewage",
    matrix %in% matrix_sewage_untreated ~ "untreated sewage",
    TRUE ~ NA
  ))
```

There are **1001** distinct CAS numbers in the UBA database and **1056** distinct compound names for the matrix we are potentially interested in.

```{r}
uba_cas_n <- UBA %>% 
  dplyr::distinct(cas_number) %>% 
  nrow(.)

uba_name_n <- UBA %>% 
  dplyr::distinct(name_of_analyte) %>% 
  nrow(.)

print(paste0("n CAS numbers = ", uba_cas_n, "; n compound names = ", uba_name_n))
```
<br>
The UBA database has entries can be single values or summary statics from a given study. We will highlight this by allocating the different statistics into to measures of central tendency (**central**: "average", "mean", "median", "timeweightedaverage_concentration") vs single values (**single**: "single_value", "single_value_of_a_composite_sample"). There are also summary values such as minimum and maximum, which we will allocate to **"other"**, we will use all of these different statistics when looking at occurrence in the database and number of environmental detections, but only the measures of central tendency and single values for concentration comparisons 

```{r}
statistics_central_tendency <- c("average", "mean", "median", "timeweightedaverage_concentration")
statistics_single <- c("single_value", "single_value_of_a_composite_sample")

statistics_select <- c(statistics_single, statistics_central_tendency)

UBA <- UBA %>% 
  dplyr::mutate(statistics_group = case_when(
    statistics %in% statistics_central_tendency ~ "central",
    statistics %in% statistics_single ~ "single",
    TRUE ~ "other"
  ))
```


## Wilkson

Here we import the complete **Wilkson dataset S4** and tidy this dataframe. We have removed all the extra headings, to just have compound name, sample number, and the site headers. We have also filled down compound name.

```{r}
setwd(input_wd)
wilkson <- read_excel("pnas.2113947119.sd04.xlsx", skip = 5) %>% 
  janitor::clean_names() %>% 
  dplyr::slice(6:1103) %>% 
  dplyr::select(-x140) %>% 
  dplyr::rename(compound_name = x1, survey_n = sampling_campaign) %>% 
  dplyr::mutate(compound_name = tolower(compound_name)) %>% 
  tidyr::fill(compound_name)
```

Changing the data to long formate. We will remove empty rows, change the concentration results to numeric, by replacing ND with 0 and removing "e" for estimated values. Lastly, we will change the value to ug/L by dividing by 1000 (it's given in ng/L).

```{r}
wilkson_long <- wilkson %>%
  tidyr::pivot_longer(
    cols = -c(compound_name, survey_n), # Columns to keep fixed
    names_to = "site",            # Column to store variable names
    values_to = "value"                # Column to store values
  ) %>%
  dplyr::mutate(
    sample_id = paste(site, survey_n, sep = "_"),
    value = str_remove_all(value, "e"),
    value = case_when(
      is.na(value) ~ NA,
      value == "ND" ~ "0",
      TRUE ~ value
    ),
    value = as.numeric(value)/1000
  ) %>% 
  dplyr::filter(!is.na(value))
```


The Wilkson database has 64,132 samples and **61 pharmaceuticals**

```{r}
n_samples <- wilkson_long %>% 
  nrow(.)

compounds <- wilkson_long %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)

print(paste0("n samples = ", n_samples, "; n compound names = ", compounds))
```

### Filtering

We **do not need to filter** the Wilkson database, all analytes are pharmaceuticals, values are in mass per volume of water, and all samples are from surface waters.

#####################
# UBA-EIPAAB crossover
######################

In this part of the code we will look at the cross over between EIPAAB and UBA <br>

First we filter the UBA for only compounds in the EIPAAB database (uba_only_eipaab_df)

```{r}
uba_only_eipaab_df <- UBA %>% 
  dplyr::filter(cas_number %in% eipaab_cas_list |
                name_of_analyte %in% eipaab_name_list |
                name_of_analyte %in% eipaab_pubchem_name_list)
```

<br>
**156 CAS** appeared are in the filtered UBA database (160 compound names). 

```{r}
eipaab_cas_in_uba_list <- uba_only_eipaab_df %>% 
  dplyr::distinct(cas_number) %>% 
  pull(cas_number)

eipaab_name_in_uba_list <- uba_only_eipaab_df %>% 
  dplyr::distinct(name_of_analyte) %>% 
  pull(name_of_analyte)

eipaab_cas_in_uba_n <- length(eipaab_cas_in_uba_list)
eipaab_name_in_uba_n <- length(eipaab_name_in_uba_list)

print(paste0("n CAS numbers = ", eipaab_cas_in_uba_n, "; n compound names = ", eipaab_name_in_uba_n))
```

## UBA-EIPAAB missing

There are **845 compounds** in UBA that are not found in the EIPAAB database. In other words, 845 pharmaceutical compounds that have not been subject to behavioural analysis of any kind. 

```{r}
UBA_remaining_cas <- UBA %>% 
  dplyr::filter(!(cas_number %in% eipaab_cas_in_uba_list)) %>% 
  dplyr::select(name_of_analyte, cas_number, number_of_samples_analysed, mec_standardized, unit_standard) %>% 
  dplyr::mutate(number_of_samples_analysed_est = if_else(is.na(number_of_samples_analysed), 1, number_of_samples_analysed))

UBA_not_in_EIPAAB <- UBA_remaining_cas %>% 
  dplyr::distinct(cas_number) %>% 
  nrow(.)

print(paste0("n not in EIPAAB = ", UBA_not_in_EIPAAB))
```

<br>
Let's see which of these compounds were detected most often in UBA, and thus could be a key target for future analysis (Table 1). <br>

#### Table 1

**Table 1:** This is a summary of the most commonly detected compounds in the UBA database (top 20) that are not in the EIPAAB database, with compound name (CAS number; where provided), number of positive detections, and the median and range of detected concentrations (not including non-detections)

```{r}
UBA_not_in_eipaab_summary <- UBA_remaining_cas %>% 
  dplyr::filter(mec_standardized > 0) %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::reframe(mean = mean(mec_standardized, na.rm = TRUE),
                 median = median(mec_standardized, na.rm = TRUE),
                 min = min(mec_standardized, na.rm = TRUE),
                 max = max(mec_standardized, na.rm = TRUE),
                 range = max-min,
                 n_postive_detection = length(mec_standardized),  # Sample size
                 sd = sd(mec_standardized, na.rm = TRUE),  # Standard deviation
                 se = sd / sqrt(n_postive_detection),  # Standard error
                 ci_lower = mean - qt(0.949, df = n_postive_detection - 1) * se,  # Lower bound of 95% CI
                 ci_upper = mean + qt(0.949, df = n_postive_detection - 1) * se   # Upper bound of 95% CI
                 ) %>% 
  dplyr::mutate(ci_lower = if_else(is.na(ci_lower), NA, ci_lower),
                ci_upper = if_else(is.na(ci_upper), NA, ci_upper))

UBA_not_in_eipaab_name_match <- UBA_remaining_cas %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(cas_number, name_of_analyte)

UBA_not_in_eipaab_summary <- UBA_remaining_cas %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::reframe(n_samples = length(mec_standardized)) %>% 
  dplyr::left_join(., UBA_not_in_eipaab_summary, by = "cas_number") %>% 
  dplyr::mutate(prop_postive = n_postive_detection/n_samples) %>% 
  dplyr::left_join(., UBA_not_in_eipaab_name_match, by = "cas_number") %>%
  dplyr::select(name_of_analyte, cas_number, everything()) %>% 
  dplyr::arrange(desc(n_postive_detection))

UBA_not_in_eipaab_summary %>% 
  dplyr::mutate(name = paste0(sentence_case(name_of_analyte), " (", cas_number, ")"),
                median_range = paste0(round(median, 4), " (", round(min,4), "–", round(max,4), ")")
                ) %>% 
  dplyr::select(name, n_postive_detection, median_range) %>% 
  dplyr::rename('Compound name (CAS number)' = name, 'Number of detections' = n_postive_detection, 'Median concentration with range (µg/L)' = median_range) %>% 
  dplyr::arrange(desc("Number of detections")) %>% 
  dplyr::slice(1:20) %>% 
  gt() %>% 
  tab_header(
    title = "UBA compounds not in EIPAAB",
    subtitle = "Top 20 compounds based on UBA detections"
  ) %>% 
  fmt_number(
    columns = "Number of detections", 
    decimals = 0
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```
<br>

*Text summary* : The most frequently detected compounds in UBA not yet covered in EIPAAB are Triclosan (cas: 3380-34-5; 1954 detections), Clofibric acid (cas: 882-09-7; 1966 detections), Estriol (cas: 50-27-1; 1505 detections), Clindamycin (cas: 18323-44-9; 756 detections), Iopromide (cas: 73334-07-3; 735 detections), Primidone (cas: 125-33-7; 835 detections), Sulfathiazole (cas: 72-14-0; 1377 detections), Hydrochlorothiazide (cas: 58-93-5; 565 detections), Phenazone (cas: 60-80-0; 1140 detections), Valsartan (cas: 137862-53-4; 506 detections).

```{r}
UBA_not_in_eipaab_summary %>% 
  dplyr::slice(1:10) %>% 
  dplyr::mutate(name_of_analyte = sentence_case(name_of_analyte), 
                text_info = paste0(name_of_analyte, " (cas: ", cas_number, "; ", n_samples, " detections)")) %>% 
  dplyr::pull(text_info) %>% 
  paste(collapse = ", ")
```

### Fixing compound synonyms

In this section we will fix compound synonyms, to make sure names and CAS are consistent across all databases. <br>

First we will identify CAS numbers with multiple names. 

```{r}
uba_cas_with_two_names <- uba_only_eipaab_df %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::reframe(names = length(unique(name_of_analyte))) %>% 
  dplyr::filter(names > 1)

uba_cas_with_two_names %>% 
  gt() %>% 
  cols_label(
    cas_number = "CAS",
    names = "Number of names"
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```
<br>
Identifying the synonyms

```{r}
uba_cas_with_two_names_pull <- uba_cas_with_two_names %>% 
  pull(cas_number)

uba_only_eipaab_df %>% 
  dplyr::filter(cas_number %in% uba_cas_with_two_names_pull) %>% 
  dplyr::group_by(name_of_analyte) %>% 
  dplyr::mutate(n = length(name_of_analyte)) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(name_of_analyte, cas_number, n) %>% 
  dplyr::mutate(name_of_analyte = sentence_case(name_of_analyte)) %>% 
  dplyr::arrange(cas_number) %>% 
  gt() %>% 
  cols_label(
    name_of_analyte = "Name",
    cas_number = "CAS",
    n = "Number of occurrences"
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```
<br>
Correcting synonyms, using the most common name

```{r}
uba_only_eipaab_df <- uba_only_eipaab_df %>% 
  dplyr::mutate(name_of_analyte = dplyr::case_when(
    cas_number == "50-28-2" ~ "17-beta-estradiol",
    cas_number == "50-48-6" ~ "amitriptyline",
    cas_number == "57-68-1" ~ "sulfamethazine",
    cas_number == "93413-62-8" ~ "desvenlafaxine",
    TRUE ~ name_of_analyte 
  )
  )
```

<br>
Checking for multiple CAS using compound name

```{r}
uba_name_with_two_cas <- uba_only_eipaab_df %>% 
  dplyr::group_by(name_of_analyte) %>% 
  dplyr::reframe(cas_n = length(unique(cas_number))) %>% 
  dplyr::filter(cas_n > 1)

uba_name_with_two_cas %>% 
  gt() %>% 
  cols_label(
    name_of_analyte = "Name",
    cas_n = "number of CAS"
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```


```{r}
uba_names_with_two_cas_pull <- uba_name_with_two_cas %>% 
  pull(name_of_analyte)

uba_only_eipaab_df %>% 
  dplyr::filter(name_of_analyte %in% uba_names_with_two_cas_pull) %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::mutate(n = length(name_of_analyte)) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(name_of_analyte = sentence_case(name_of_analyte)) %>% 
  dplyr::select(name_of_analyte, cas_number, n) %>% 
  dplyr::arrange(name_of_analyte) %>% 
  gt() %>% 
  cols_label(
    name_of_analyte = "Name",
    cas_number = "CAS number",
    n = "Number of occurrences"
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```
<br>
Correcting the missing CAS

```{r}
uba_only_eipaab_df <- uba_only_eipaab_df %>% 
  dplyr::mutate(cas_number = dplyr::case_when(
    name_of_analyte == "guanylurea" ~ "141-83-3",
    TRUE ~ cas_number 
  )
  )
```

<br>
There are now **156 CAS and compounds** that are shared across the two databases

```{r}
n_compound_names <- uba_only_eipaab_df %>% 
  dplyr::distinct(name_of_analyte) %>% 
  nrow(.)

n_compound_cas <- uba_only_eipaab_df %>% 
  dplyr::distinct(cas_number) %>% 
  nrow(.)

print(paste0("n compound names = ", n_compound_names, "; n compound cas = ", n_compound_cas))
```


## Tidy compound identifiers

Now we will match CAS number and corresponding compound names to UBA to make it consistent with EIPAAB. <br>

This code makes a list of CAS and compound names from EIPAAB, which we will add to UBA, by filter the EIPAAB database for only compounds shared across both.

```{r}
cas_filter <- uba_only_eipaab_df %>% 
  dplyr::distinct(cas_number) %>% 
  dplyr::arrange(cas_number) %>% 
  pull(cas_number)

name_filter <- uba_only_eipaab_df %>% 
  dplyr::distinct(name_of_analyte) %>% 
  dplyr::arrange(name_of_analyte) %>% 
  pull(name_of_analyte)

EIPAAB_con_long_uba <- EIPAAB_con_long %>% 
  dplyr::filter(compound_cas %in% cas_filter | compound_name %in% name_filter |
                  compound_pubchem_name %in% name_filter) %>% 
  dplyr::mutate(n_units_est = n_units)

eipaab_compound_identifier <- EIPAAB_con_long_uba %>% 
  dplyr::select(compound_cas, compound_name, compound_pubchem_name) %>% 
  dplyr::group_by(compound_cas) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()
```

<br>
Now we will make a list where the CAS doesn't match and what the actual the CAS should be based on the compound name

```{r}
cas_doesnt_match <- uba_only_eipaab_df %>% 
  dplyr::select(name_of_analyte, cas_number) %>% 
  dplyr::group_by(cas_number) %>% 
  dplyr::slice(1) %>% 
  dplyr::left_join(., eipaab_compound_identifier, by = c("cas_number" = "compound_cas")) %>% 
  dplyr::filter(is.na(compound_name)) %>% 
  pull(name_of_analyte)

cas_match_name <- eipaab_compound_identifier %>% 
  dplyr::filter(compound_name %in% cas_doesnt_match) %>% 
  dplyr::select(compound_name, compound_cas) %>% 
  dplyr::rename(name = compound_name, correct_cas = compound_cas)

cas_match_pub_chem <- eipaab_compound_identifier %>% 
  dplyr::filter(compound_pubchem_name %in% cas_doesnt_match) %>% 
  dplyr::select(compound_pubchem_name, compound_cas) %>% 
  dplyr::rename(name = compound_pubchem_name, correct_cas = compound_cas)

cas_match_all <- rbind(cas_match_name, cas_match_pub_chem) %>% 
  dplyr::group_by(name) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup()
```

<br>
Now we will add this list of corrected CAS numbers to the database

```{r}
uba_eipaab_tidy <- uba_only_eipaab_df %>% 
  dplyr::left_join(., cas_match_all, by = c("name_of_analyte" = "name")) %>% 
  dplyr::mutate(compound_cas = if_else(is.na(correct_cas), cas_number, correct_cas)) %>% 
  dplyr::select(-correct_cas) %>% 
  dplyr::left_join(., eipaab_compound_identifier, by = "compound_cas") %>% 
  dplyr::rename(name_uba = name_of_analyte, cas_uba = cas_number)
```

<br>
Now we will rename columns and select only relevant columns to combined into a UBA and EIPAAB data frame

```{r}
uba_con_long <- uba_eipaab_tidy %>%
  dplyr::select(id, compound_cas, compound_name, compound_pubchem_name, statistics_group, mec_standardized, matrix_group, number_of_samples_analysed) %>% 
  dplyr::rename(unique_row_id = id, concentration_type = statistics_group, value = mec_standardized, n_units = number_of_samples_analysed) %>%
  dplyr::mutate(source = "uba",
                n_units_est = if_else(is.na(n_units), 1, n_units))
```


## EIPAAB_UBA

This section we make the combined UBA and EIPAAB data frame **eipaab_uba**, to look at occurrence relationships and concentrations. 

```{r}
eipaab_uba <- rbind(EIPAAB_con_long_uba, uba_con_long) %>% 
  dplyr::mutate(matrix_group = factor(matrix_group, levels = c("test", 
                                                               "untreated sewage",
                                                               "inflow",
                                                               "treated sewage",
                                                               "effluent",
                                                               "surfacewater"
                                                               )))
```


## Occurrence

Let's see if there is a correlation between the sample occurrence in UBA and EIPAAB, as well as the number of positive environmental detections in UBA and EIPAAB occurrence. <br>

Here we make a summary data frame for each compound, **eipaab_uba_counts**, that includes the number of occurrences in each database, the rank occurrence, the number of detections in the UBA database, the proportion of positive detections in UBA, the rank order of detections, the relative rank order of environmental detections in UBA versus occurrence in EIPAAB (see Table 2). <br>

#### Table 2
**Table 2:** the 10 most common compounds in EIPAAB versus occurrence and detection frequency in UBA.

```{r}
eipaab_counts <- eipaab_uba %>% 
  dplyr::filter(source == "eipaab") %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(n_eipaab = sum(n_units_est, na.rm = TRUE)) %>% 
  ungroup() %>% 
  tidyr::complete(., compound_name)

uba_counts <- eipaab_uba %>% 
  dplyr::filter(source == "uba") %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(n_uba_units = sum(n_units_est, na.rm = TRUE),
                 n_rows = length(unique_row_id)) %>% 
  ungroup() %>% 
  tidyr::complete(., compound_name)

uba_counts_pos <- eipaab_uba %>% 
  dplyr::filter(source == "uba") %>% 
  dplyr::filter(value > 0) %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(n_postive_detection = length(unique_row_id)) %>% 
  ungroup()

eipaab_uba_counts <- left_join(eipaab_counts, uba_counts, by = "compound_name") %>% 
  left_join(., uba_counts_pos, by = "compound_name") %>% 
  dplyr::mutate(n_postive_detection = if_else(is.na(n_postive_detection), 0, n_postive_detection),
                rank_samples_uba = rank(n_uba_units, ties.method = "min"),
                rank_detection_uba = rank(n_postive_detection, ties.method = "min"),
                rank_eipaab = rank(n_eipaab, ties.method = "min"),
                rank_samples_dif = rank_samples_uba-rank_eipaab,
                rank_detection_dif = rank_detection_uba-rank_eipaab,
                log_n_detections_uba = if_else(n_postive_detection > 0, log(n_postive_detection), n_postive_detection),
                log_n_eipaab = log(n_eipaab),
                prop_postive = n_postive_detection/n_rows) %>% 
  dplyr::arrange(desc(rank_detection_dif)) %>% 
  dplyr::mutate(rank_detection_dif = 1:nrow(.))

eipaab_uba_counts %>% 
  dplyr::arrange(desc(n_eipaab)) %>% 
  dplyr::slice(1:10) %>% 
  dplyr::mutate(compound_name = sentence_case(compound_name)) %>% 
  dplyr::select(compound_name, n_eipaab, n_uba_units, n_postive_detection, rank_detection_dif) %>% 
  dplyr::rename(Name = compound_name, "EIPAAB tests" = n_eipaab, "UBA samples" = n_uba_units, "Detections" = n_postive_detection, "Rank difference in detections and testing" = rank_detection_dif) %>% 
  gt() %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```



### Results

There's massive skew in occurrence for specific compounds in both the UBA and EIPAAB database. There is generally, a positive correlation between detections in the UBA and occurrence in the EIAPAAB database (Spearman's rank correlation: rho = 0.48, p < 0.001; Fig 1).With that said, there are a number of compounds that occurrence frequently in the UBA that are not well represented in the EIPAAB database see below. These could be sensible targets for future behavioural tests. <br>

Spearman's rank correlation between the number of detections in UBA and occurrence in the EIAPAAB database.

```{r}
cor_detection_results <- cor.test(eipaab_uba_counts$log_n_detections_uba, eipaab_uba_counts$n_eipaab, method = "spearman",
         exact = NULL, conf.level = 0.95, continuity = FALSE)

detection_effect_estimate <- cor_detection_results$estimate
detection_effect_p <- cor_detection_results$p.value

cor_detection_results
```
<br>
Spearman's rank correlation between the proportion of positive detections and the occurrence in EIPAAB. This may be unreliable for compounds with very few samples. There is a week positive correlation. 

```{r}
postive_cor_results <- cor.test(eipaab_uba_counts$prop_postive, eipaab_uba_counts$n_eipaab, method = "spearman",
         exact = NULL, conf.level = 0.95, continuity = FALSE)

postive_cor_results

postive_effect_estimate <- postive_cor_results$estimate
postive_effect_p <- postive_cor_results$p.value
```

##### Fig 1
**Fig 1:** the relationship between the number of detections in the PHARMS-UBA database for environmental occurrence of pharmaceuticals (Surface waters, WWTP inflow/effluent, Treated/Untreated sewage, *only*), and the occurance in the Evidence of the Impacts of Pharmaceuticals on Aquatic Animal Behaviour (EIPAAB) database.

```{r}
fig_1 <- eipaab_uba_counts %>%
  dplyr::mutate(is_top5 = rank_detection_dif %in% 1:5) %>%   # Flag for top 5 points
  ggplot(aes(x = log_n_detections_uba, y = log_n_eipaab, fill = rank_detection_dif, size = rank_detection_dif)) +
  geom_smooth(colour = "#36454F", fill =  "#36454F", size =  NA, se = TRUE, linewidth = 2) +
  geom_point(
    aes(colour = is_top5, stroke = ifelse(is_top5, 1.5, 0.5)),  # Thicker outline for top 10
    alpha = 0.6,
    shape = 21
  ) +
  annotate(
    "text",
    x = min(eipaab_uba_counts$log_n_detections_uba),  # Position at the top-left (adjust `x` as needed)
    y = max(eipaab_uba_counts$log_n_eipaab),  # Position at the top
    label = paste0(
      "Spearman's rank correlation", "\n",
      "Effect size: ", round(detection_effect_estimate, 3), "\n",
      "p-value: ", signif(detection_effect_p, 3)
    ),
    hjust = 0, vjust = 1,  # Align text to the top-left
    size = 4
  ) +
  scale_fill_gradientn(colours = colorspace::diverge_hcl(7)) +
  scale_colour_manual(
    values = c("TRUE" = "black", "FALSE" = "black"),  # Golden colour for top 10
    guide = "none"  # Remove legend for colour
  ) +
  geom_text_repel(
    data = . %>% dplyr::filter(is_top5),  # Filter top 10 rank_diff_order
    aes(label = compound_name),
    size = 3,
    box.padding = 0.7,
    min.segment.length = 0,
    hjust = 0, vjust = 5  # Adjust text position
  ) +
  theme_clean() +
  labs(x = "log(Count) of detections in UBA",
       y = "log(Count) of occurrence in EIPAAB",
       fill = "Rank difference",
       size = "Rank difference") +
    theme(
    legend.position = "bottom",  # Move legend to the top
    legend.justification = "center"  # Align legend to the left
  )
fig_1
```
<br>
***Note:*** *the size and colour of the points represents the difference in the rank occurrence in EIPAAB versus the rank detections in UBA (i.e. rank EIPAAB - rank UBA), where larger values suggest that the compound is overrepresented in EIPAAB.*

<br>
This code saves the figure above as PDF

```{r}
ggsave(filename = paste0(output_fig_wd, "./figure-1.pdf"), 
       plot = fig_1,
       width = 210,
       height = 297/1.5,  # Specify the height of the plot
       units = "mm")
```


<br>
**Table 3:** The compounds with the largest differences between rank occurrence in the EIPAAB database and detections in the UBA.

```{r}
eipaab_uba_counts %>% 
  dplyr::arrange(rank_detection_dif) %>% 
  dplyr::slice(1:10) %>% 
  dplyr::mutate(compound_name = sentence_case(compound_name)) %>% 
  dplyr::select(compound_name, n_eipaab, n_uba_units, n_postive_detection, rank_detection_dif) %>% 
  dplyr::rename(Name = compound_name, "EIPAAB tests" = n_eipaab, "UBA samples" = n_uba_units, "Detections" = n_postive_detection, "Rank difference in detections and testing" = rank_detection_dif) %>% 
  gt() %>% 
  fmt_number(
    columns = c("UBA samples", "Detections"), 
    decimals = 0
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```

## Concentration 

For questions around concentration, we have filtered for only cases where the levels are above zero (i.e. positive detections). This was done under the assumption that when researchers are trying to estimate the risk of exposure, they are emulating an exposed at a contaminated site, not the global surface water average. In taking this approach—as opposed to using some value below detection limit—we are trying to be ***more conservative*** with the relative comparison between tested doses in behavioural ecotoxicology and observed environmental doses.
 
 <br>

In this section we are calculating summary metrics for concentrations used in the behavioural test, and for UBA, the concentrations  in effluent and surface waters (there are other matrix, but these are the once we will focus on in this study). We are calculating, the mean, median, min, max, range, n (number of contributing data points), standard deviation (sd), standard error (se), and the upper and lower 95% confidence intervals (ci_upper, ci_lower).

```{r}
concentration_type_remove <- c("other", "max")
matrix_group_intrest <- c("test", "effluent", "surfacewater")

eipaab_uba_conc_summary <- eipaab_uba %>% 
  dplyr::filter(value > 0, 
                !(concentration_type %in% concentration_type_remove),
                matrix_group %in% matrix_group_intrest) %>% 
  dplyr::group_by(matrix_group, compound_name) %>% 
  dplyr::reframe(mean = mean(value, na.rm = TRUE),
                 median = median(value, na.rm = TRUE),
                 min = min(value, na.rm = TRUE),
                 max = max(value, na.rm = TRUE),
                 range = max-min,
                 n = sum(n_units_est, na.rm = TRUE),  # Sample size
                 sd = sd(value, na.rm = TRUE),  # Standard deviation
                 se = sd / sqrt(n),  # Standard error
                 ci_lower = mean - qt(0.949, df = n - 1) * se,  # Lower bound of 95% CI
                 ci_upper = mean + qt(0.949, df = n - 1) * se   # Upper bound of 95% CI
                 ) %>% 
  dplyr::mutate(ci_lower = if_else(is.na(ci_lower), NA, ci_lower),
                ci_upper = if_else(is.na(ci_upper), NA, ci_upper)) %>% 
  tidyr::complete(
    tidyr::expand(nesting(matrix_group, compound_name))
  )
```

<br>
Here we will add the summary statistics from above to the full eipaab_uba database, so we can see how many EIPAAB tested concentrations fall under the median surface water and effluent concentrations for each compound.

```{r}
rename_cols <- eipaab_uba_conc_summary %>% 
  dplyr::select(-matrix_group, -compound_name) %>% 
  colnames()

eipaab_uba_conc_summary_eff <- eipaab_uba_conc_summary %>% 
  dplyr::filter(matrix_group == "effluent") %>% 
   dplyr::rename_with(
    .cols = all_of(rename_cols),  # Select columns to rename
    .fn = ~ paste0("effluent_", .)  # Prefix with "effluent_"
  ) %>% 
  dplyr::select(-matrix_group)


eipaab_uba_conc_summary_surf <- eipaab_uba_conc_summary %>% 
  dplyr::filter(matrix_group == "surfacewater") %>% 
   dplyr::rename_with(
    .cols = all_of(rename_cols),  # Select columns to rename
    .fn = ~ paste0("surfacewater_", .)  # Prefix with "effluent_"
  ) %>% 
  dplyr::select(-matrix_group)


eipaab_uba_with_sum <- eipaab_uba %>% 
  dplyr::filter(matrix_group == "test") %>% 
  dplyr::left_join(., eipaab_uba_conc_summary_surf, by = "compound_name") %>% 
  dplyr::left_join(., eipaab_uba_conc_summary_eff, by = "compound_name") %>% 
  dplyr::mutate(under_med_surf = if_else(value < surfacewater_median, 1, 0),
                under_hci_surf = if_else(value < surfacewater_ci_upper, 1, 0),
                under_med_effl = if_else(value < effluent_median, 1, 0),
                under_hci_effl = if_else(value < effluent_ci_upper, 1, 0),
                diff_med_surf = value/surfacewater_median,
                diff_hic_surf = value/surfacewater_ci_upper,
                diff_med_effl = value/effluent_median,
                diff_hic_effl = value/effluent_ci_upper
                )
```


### Results

For the 155 compounds in the EIPAAB database that had associated data in UBA (representing 1,440 exposures), only 7.53% and 25.68% employed test concentrations lower then median and upper 95% credible interval of surface water concentrations, respectively (Table 4). Further, only 11.77% and 29.79% employed test concentrations lower then median and upper 95% credible interval of wastewater treatment plant effluent (Table 4). On average, concentrations used in behavioural ecotoxicology were 309 times higher then median surf water concentrations, and 12 times higher then those in effluent. <br>

##### Table 3
**Table 3:** The number of exposures in the EIPAAB database that used concentrations less then median and upper 95% credible interval of surface water and effluent concentrations in the UBA database

```{r}
n_with_uba_data <- eipaab_uba_with_sum %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)
n_with_uba_data

eipaab_uba_conc_summary <- eipaab_uba_with_sum %>% 
  dplyr::reframe(n_eipaab = length(unique_row_id),
                 n_sw = sum(!is.na(under_med_surf)),
                 less_med_sw = sum(under_med_surf, na.rm = TRUE),
                 less_hci_sw = sum(under_hci_surf, na.rm = TRUE),
                 prop_less_med_sw = less_med_sw/n_sw,
                 prop_less_hic_sw = less_hci_sw/n_sw,
                 n_ef = sum(!is.na(under_med_effl)),
                 less_med_ef = sum(under_med_effl, na.rm = TRUE),
                 less_hci_ef = sum(under_hci_effl, na.rm = TRUE),
                 prop_less_med_ef = less_med_ef/n_ef,
                 prop_less_hic_ef = less_hci_ef/n_ef,
                 fdiff_med_sw = median(diff_med_surf, na.rm = TRUE),
                 fdiff_hci_sw = median(diff_hic_surf, na.rm = TRUE),
                 fdiff_med_ef = median(diff_med_effl, na.rm = TRUE),
                 fdiff_hci_ef = median(diff_hic_effl, na.rm = TRUE),
                 ) %>% 
  dplyr::mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))

surf <- eipaab_uba_conc_summary %>% 
  dplyr::select(n_sw, less_med_sw, less_hci_sw, prop_less_med_sw, prop_less_hic_sw) %>% 
  dplyr::rename(total_n = n_sw, less_med = less_med_sw, less_hci = less_hci_sw, prop_less_med = prop_less_med_sw, prop_less_hic = prop_less_hic_sw) %>% 
  dplyr::mutate(matrix = "Surface water")

effluent <- eipaab_uba_conc_summary %>% 
  dplyr::select(n_ef, less_med_ef, less_hci_ef, prop_less_med_ef, prop_less_hic_ef) %>% 
  dplyr::rename(total_n = n_ef, less_med = less_med_ef, less_hci = less_hci_ef, prop_less_med = prop_less_med_ef, prop_less_hic = prop_less_hic_ef) %>% 
  dplyr::mutate(matrix = "Effluent")

rbind(surf, effluent) %>% 
  dplyr::select(matrix, everything()) %>% 
  dplyr::mutate(prop_less_med = round(prop_less_med, 3),
                prop_less_hic = round(prop_less_hic, 3)) %>% 
  dplyr::rename(Matrix = matrix, 'Total tests' = total_n, 'Dose less than median' = less_med, 'Dose less than upper 95%CI' = less_hci,
                'Proportion less than median' = prop_less_med, 'Proportion less than upper 95%CI' = prop_less_hic) %>% 
  gt() %>% 
  fmt_number(
    columns = 'Total tests', 
    decimals = 0
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
  
```
<br>
Now we will make a summary for each compound

```{r}
sample_counts <- eipaab_uba_with_sum %>% 
  dplyr::select(compound_name, surfacewater_n, effluent_n) %>% 
  group_by(compound_name) %>% 
  dplyr::slice(1) %>% 
  ungroup()

eipaab_uba_under_levels <- eipaab_uba_with_sum %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(n_eipaab = length(unique_row_id),
                 n_sw = sum(!is.na(under_med_surf)),
                 less_med_sw = sum(under_med_surf, na.rm = TRUE),
                 less_hci_sw = sum(under_hci_surf, na.rm = TRUE),
                 prop_less_med_sw = less_med_sw/n_sw,
                 prop_less_hic_sw = less_hci_sw/n_sw,
                 n_ef = sum(!is.na(under_med_effl)),
                 less_med_ef = sum(under_med_effl, na.rm = TRUE),
                 less_hci_ef = sum(under_hci_effl, na.rm = TRUE),
                 prop_less_med_ef = less_med_ef/n_ef,
                 prop_less_hic_ef = less_hci_ef/n_ef,
                 fdiff_med_sw = median(diff_med_surf, na.rm = TRUE),
                 fdiff_hci_sw = median(diff_hic_surf, na.rm = TRUE),
                 fdiff_med_ef = median(diff_med_effl, na.rm = TRUE),
                 fdiff_hci_ef = median(diff_hic_effl, na.rm = TRUE),
                 ) %>% 
  dplyr::left_join(., sample_counts, by = "compound_name") %>% 
  dplyr::mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))
```


##### Fig 2a

**Fig 2a.** The median difference in tested concentrations in EIPAAB and median surface water concentration in UBA (i.e. tested dose ÷ median surface water concentration)

```{r, fig.height=15, fig.width=5}
fdiff_med_sw_order <- eipaab_uba_under_levels %>% 
  dplyr::filter(!is.na(fdiff_med_sw)) %>% 
  dplyr::arrange(desc(fdiff_med_sw)) %>% 
  dplyr::mutate(order = 1:nrow(.),
                compound_name = sentence_case(compound_name)) %>% 
  pull(compound_name)

vline_data <- data.frame(xintercept = log(10^(0:9)),
                         xlabs = as.character(10^(0:9))) %>% 
  dplyr::mutate(xlabs = paste0("×",xlabs))

median <- eipaab_uba_conc_summary %>% 
  dplyr::pull(fdiff_med_sw) %>% 
  log()

fig_2a <- eipaab_uba_under_levels %>% 
  dplyr::filter(!is.na(fdiff_med_sw)) %>% 
  dplyr::mutate(compound_name = sentence_case(compound_name),
                compound_name = factor(compound_name, levels = rev(fdiff_med_sw_order))) %>% 
  ggplot(aes(x = log(fdiff_med_sw), y = compound_name, size = n_eipaab, fill = log(surfacewater_n))) +
  geom_vline(data = vline_data, aes(xintercept = xintercept), linetype = "dashed", colour = "black") +  # Add multiple lines
  geom_vline(xintercept = median, colour = "darkred") +
  geom_text(data = vline_data, aes(x = xintercept, y = "clozapine", label = xlabs), inherit.aes = FALSE,
            angle = 90, vjust = -0.5, hjust = 1, size = 3) +
  geom_point(alpha = 0.5, shape = 21) +
  theme_classic() +
  scale_fill_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(
    legend.position = "bottom",  # Move legend to the top
    legend.justification = "center",  # Align legend to the left
  ) +
  labs(
    subtitle = "Tested concentrations vs median surfwater water",
    x = "Log mean fold difference between tested and median surfwater water concentrations",
    y = "Compounds",
    size = "Data in EIPAAB",
    fill = "Data in UBA"
  ) +
    theme(
    legend.position = "bottom",  # Move legend to the top
    legend.justification = "center"  # Align legend to the left
  )

fig_2a
```
<br>
***Note:*** *the size and colour of the point represents the number of occurrences in EIPAAB* 

<br>
Save the figure

```{r}
ggsave(filename = paste0(output_fig_wd, "./figure-2a.pdf"), 
       plot = fig_2a,
       width = 210/2,
       height = 297,  # Specify the height of the plot
       units = "mm")
```

<br>
##### Fig 2b
**Fig 2b.** The median difference in tested concentrations in EIPAAB and median effluent concentration in UBA (i.e. tested dose ÷ median effluent concentration)

```{r, fig.height=15, fig.width=5}
fdiff_med_ef_order <- eipaab_uba_under_levels %>%
  dplyr::filter(!is.na(fdiff_med_ef)) %>%
  dplyr::arrange(desc(fdiff_med_ef)) %>%
  dplyr::mutate(order = 1:nrow(.),
                compound_name = sentence_case(compound_name)) %>%
  pull(compound_name)

vline_data <- data.frame(xintercept = log(10^(0:8)),
                         xlabs = as.character(10^(0:8))) %>% 
  dplyr::mutate(xlabs = paste0("×",xlabs))

median <- eipaab_uba_conc_summary %>% 
  dplyr::pull(fdiff_med_ef) %>% 
  log()

fig_2b <- eipaab_uba_under_levels %>% 
  dplyr::filter(!is.na(fdiff_med_ef)) %>% 
  dplyr::mutate(compound_name = sentence_case(compound_name),
                compound_name =factor(compound_name, levels = rev(fdiff_med_ef_order))) %>%
  ggplot(aes(x = log(fdiff_med_ef), y = compound_name, size = n_eipaab, fill = log(surfacewater_n))) +
  geom_vline(data = vline_data, aes(xintercept = xintercept), linetype = "dashed", colour = "black") +  # Add multiple lines
  geom_vline(xintercept = median, colour = "darkred") +
  geom_text(data = vline_data, aes(x = xintercept, y = "clozapine", label = xlabs), inherit.aes = FALSE,
            angle = 90, vjust = -0.5, hjust = 1, size = 3) +
  geom_point(alpha = 0.5, shape = 21) +
  theme_classic() +
  scale_fill_gradientn(colours = colorspace::diverge_hcl(7)) +
  theme(
    legend.position = "bottom",  # Move legend to the top
    legend.justification = "center",  # Align legend to the left
  ) +
  labs(
    subtitle = "Tested concentrations vs median efflent",
    x = "Log mean fold difference between tested and median efflent concentrations",
    y = "Compounds",
    size = "Data in EIPAAB",
    fill = "Data in UBA"
  ) +
    theme(
    legend.position = "bottom",  # Move legend to the top
    legend.justification = "center"  # Align legend to the left
  ) 
fig_2b
```
<br>
***Note:*** *the size and colour of the point represents the number of occurrences in EIPAAB. The red line represents the median fold difference* 

```{r}
ggsave(filename = paste0(output_fig_wd, "./figure-2b.pdf"), 
       plot = fig_2b,
       width = 210/2,
       height = 297,  # Specify the height of the plot
       units = "mm")
```


##########################
# Wilkson-EIPAAB crossover
##########################

Let's see how many of the 184 compounds in EIPAAB (filtered) are in the Wilkson database. <br>

Wilkson had 42 of the compounds, which is 69% of the compounds in the Wilkson database.

```{r}
eipaab_compound_name_list <- EIPAAB_con_long %>% 
  dplyr::distinct(compound_name) %>% 
  dplyr::pull(compound_name)

eipaab_compound_pubchem_name_list <- EIPAAB_con_long %>% 
  dplyr::distinct(compound_pubchem_name) %>% 
  dplyr::pull(compound_pubchem_name)

wilkson_in_eipaab <- wilkson_long %>% 
  dplyr::filter(compound_name %in% eipaab_compound_name_list |
                  compound_name %in% eipaab_compound_pubchem_name_list) 

n_in <- wilkson_in_eipaab %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)

n_total <- wilkson_long %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)

n_in
n_total
round(n_in/n_total,2)
```

<br>
We will check the missing compound more closely to see if they have used a synonym. Ideally the database would have included CAS to cross check. In this case, we will search each of the 19 missing compounds in PubChem and identify the CAS number, so we can use that to search EIPAAB

```{r}
wilkson_not_in_eipaab <- wilkson_long %>% 
  dplyr::filter(!(compound_name %in% eipaab_compound_name_list)) %>% 
  dplyr::filter(!(compound_name %in% eipaab_compound_pubchem_name_list)) %>% 
  dplyr::distinct(compound_name)

wilkson_not_in_eipaab_cas <- wilkson_not_in_eipaab %>% 
  dplyr::mutate(compound_cas = case_when(
    compound_name == "artemisinin" ~ "63968-64-9",
    compound_name == "cloxacillin" ~ "61-72-3",
    compound_name == "cotinine" ~ "486-56-6",
    compound_name == "fluconazole" ~ "86386-73-4",
    compound_name == "hydrocodone" ~ "125-29-1",
    compound_name == "itraconazole" ~ "84625-61-6",
    compound_name == "ketotifen" ~ "34580-13-7",
    compound_name == "loratadine" ~ "79794-75-5",
    compound_name == "miconazole" ~ "22916-47-8",
    compound_name == "nevirapine" ~ "129618-40-2",
    compound_name == "norethisterone" ~ "68-22-4",
    compound_name == "norfluoxetine" ~ "83891-03-6",
    compound_name == "oseltamivir" ~ "196618-13-0",
    compound_name == "pregabalin" ~ "148553-50-8",
    compound_name == "raloxifene" ~ "84449-90-1",
    compound_name == "salbutamol" ~ "18559-94-9",
    compound_name == "sitagliptin" ~ "486460-32-6",
    compound_name == "thiabendazole" ~ "148-79-8",
    compound_name == "triamterene" ~ "396-01-0",
    TRUE ~ NA
  )
  )

wilkson_not_in_eipaab_cas_list <- wilkson_not_in_eipaab_cas %>% 
  dplyr::pull(compound_cas)
```

<br>
Searching EIPAAB for these CAS numbers. Only one was located norethindrone (68-22-4), which is called norethisterone in the Wilkson database 

```{r}
EIPAAB_con_long %>% 
  dplyr::filter(compound_cas %in% wilkson_not_in_eipaab_cas_list) %>% 
  dplyr::group_by(compound_cas) %>% 
  dplyr::slice(1) %>% 
  dplyr::select(compound_cas, compound_name, compound_pubchem_name)
```
<br>
We will rename it in the Wilkson database and then filter again, and add the CAS numbers from EIPAAB. Now we have 43 compounds cross-overs with Wilkson and EIPAAB (70% of all Wilkinson).

```{r}
wilkson_in_eipaab <- wilkson_long %>% 
  dplyr::mutate(compound_name = if_else(compound_name == "norethisterone", "norethindrone", compound_name)) %>% 
  dplyr::filter(compound_name %in% eipaab_compound_name_list |
                  compound_name %in% eipaab_compound_pubchem_name_list)

n_in <- wilkson_in_eipaab %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)

n_total <- wilkson_long %>% 
  dplyr::distinct(compound_name) %>% 
  nrow(.)

n_in
n_total
round(n_in/n_total,2)
```

<br>
Adding CAS numbers

```{r}
EIPAAB_identifiers_name <- EIPAAB_con_long %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(compound_name, compound_cas, compound_pubchem_name)

EIPAAB_identifiers_pubchem <- EIPAAB_con_long %>% 
  dplyr::group_by(compound_pubchem_name) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(compound_cas, compound_pubchem_name) %>% 
  dplyr::rename(compound_name = compound_pubchem_name,
                compound_cas_pubchem = compound_cas)

wilkson_in_eipaab <- wilkson_in_eipaab %>% 
  dplyr::left_join(., EIPAAB_identifiers_name, by = "compound_name") %>% 
  dplyr::left_join(., EIPAAB_identifiers_pubchem, by = "compound_name") %>% 
  dplyr::mutate(compound_cas = if_else(is.na(compound_cas), compound_cas_pubchem, compound_cas)) %>% 
  dplyr::select(-compound_cas_pubchem)
```


### Missing from EIPAAB

What compounds are in Wilkson that are not in EIPAAB <br>

#### Table 4 

**Table 4:** Compounds detected in the Wilkson *et al.* (2022) database that are not in the EIPAAB database, with compound name (CAS number), number of positive detections, and the median and range of detected concentrations (not including non-detections)

```{r}
wilkson_not_in_eipaab <- wilkson_long %>% 
  dplyr::mutate(compound_name = if_else(compound_name == "norethisterone", "norethindrone", compound_name)) %>% 
  dplyr::filter(!(compound_name %in% eipaab_compound_name_list)) %>%
  dplyr::filter(!(compound_name %in% eipaab_compound_pubchem_name_list))

wilkson_not_in_eipaab_summary <- wilkson_not_in_eipaab %>% 
  dplyr::filter(value > 0) %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(mean = mean(value, na.rm = TRUE),
                 median = median(value, na.rm = TRUE),
                 min = min(value, na.rm = TRUE),
                 max = max(value, na.rm = TRUE),
                 range = max-min,
                 n_postive_detection = length(value),  # Sample size
                 sd = sd(value, na.rm = TRUE),  # Standard deviation
                 se = sd / sqrt(n_postive_detection),  # Standard error
                 ci_lower = mean - qt(0.949, df = n_postive_detection - 1) * se,  # Lower bound of 95% CI
                 ci_upper = mean + qt(0.949, df = n_postive_detection - 1) * se   # Upper bound of 95% CI
                 ) %>% 
  dplyr::mutate(ci_lower = if_else(is.na(ci_lower), NA, ci_lower),
                ci_upper = if_else(is.na(ci_upper), NA, ci_upper))

wilkson_not_in_eipaab_summary <- wilkson_not_in_eipaab %>% 
  dplyr::group_by(compound_name) %>% 
  dplyr::reframe(n_samples = length(value)) %>% 
  dplyr::left_join(., wilkson_not_in_eipaab_summary, by = "compound_name") %>% 
  dplyr::mutate(prop_postive = n_postive_detection/n_samples) %>% 
  dplyr::left_join(., wilkson_not_in_eipaab_cas, by = "compound_name") %>%
  dplyr::arrange(desc(n_postive_detection))


wilkson_not_in_eipaab_summary %>% 
  dplyr::filter(n_postive_detection > 0) %>%
  dplyr::mutate(name = paste0(sentence_case(compound_name), " (", compound_cas, ")"),
                median_range = paste0(round(median, 4), " (", round(min,4), "–", round(max,4), ")")
                )%>% 
  dplyr::select(name, n_postive_detection, median_range) %>% 
  dplyr::rename('Compound name (CAS number)' = name, 'Number of detections' = n_postive_detection, 'Median concentration with range (µg/L)' = median_range) %>% 
  dplyr::arrange(desc("Number of detections")) %>% 
  dplyr::slice(1:20) %>% 
  gt() %>% 
  tab_header(
    title = "Wilkson et al. compounds not in EIPAAB",
    subtitle = "Compounds detected in at least one site in Wilkson et al. (2022)"
  ) %>% 
  fmt_number(
    columns = "Number of detections", 
    decimals = 0
  ) %>% 
  cols_align(
    align = "center", 
    columns = everything()
  )
```

<br>
*Text summary* : Compounds that were detected in Wilkson but are in EIPAAB inculdes: Cotinine (CAS: 486-56-6; 386 detections), Sitagliptin (CAS: 486460-32-6; 323 detections), Hydrocodone (CAS: 125-29-1; 82 detections), Fluconazole (CAS: 86386-73-4; 81 detections), Pregabalin (CAS: 148553-50-8; 72 detections), Nevirapine (CAS: 129618-40-2; 64 detections), Triamterene (CAS: 396-01-0; 48 detections), Salbutamol (CAS: 18559-94-9; 40 detections), Loratadine (CAS: 79794-75-5; 21 detections), Thiabendazole (CAS: 148-79-8; 17 detections), Artemisinin (CAS: 63968-64-9; 8 detections), Oseltamivir (CAS: 196618-13-0; 4 detections), Itraconazole (CAS: 84625-61-6; 1 detections), Ketotifen (CAS: 34580-13-7; 1 detections)

```{r}
wilkson_not_in_eipaab_summary %>% 
  dplyr::filter(n_postive_detection > 0) %>% 
  dplyr::mutate(text_info = paste0(sentence_case(compound_name), " (CAS: ", compound_cas, "; ", n_postive_detection, " detections)")) %>% 
  dplyr::pull(text_info) %>% 
  paste(collapse = ", ")
```


### EIPAAB_Wilkson

```{r}
wilkson_in_eipaab
```

### Occurrence

```{r}
wilkson_in_eipaab
```


